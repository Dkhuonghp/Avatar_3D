{
  "version": 3,
  "sources": ["../../src/server/index.ts", "../../src/server/index.ts", "../../src/internal/dom.ts", "../../src/sheets/index.ts", "../../src/server/index.ts"],
  "sourcesContent": ["/* eslint-env node */\n// ^^^^ This comment is need to prevent browser bundles of this file\n\nimport { executionAsyncId, createHook } from 'async_hooks'\n\nimport type { Sheet, SheetInit } from '../types'\nimport { virtualSheet } from '../sheets'\n\nexport type { Storage, StyleTagProperties, StyleTagSheet, VirtualSheet } from '../sheets'\nexport { virtualSheet, getStyleTag, getStyleTagProperties } from '../sheets'\n\nexport interface AsyncVirtualSheet extends Sheet {\n  readonly target: readonly string[]\n  init: SheetInit\n  reset: () => void\n  enable: () => void\n  disable: () => void\n}\n\ninterface Snapshot {\n  state: unknown[] | undefined\n}\n\nexport const asyncVirtualSheet = (): AsyncVirtualSheet => {\n  const sheet = virtualSheet()\n  const initial = sheet.reset()\n\n  const store = new Map<number, Snapshot>()\n\n  const asyncHook = createHook({\n    init(asyncId, type, triggerAsyncId) {\n      const snapshot = store.get(triggerAsyncId)\n\n      if (snapshot) {\n        store.set(asyncId, snapshot)\n      }\n    },\n\n    before(asyncId) {\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        sheet.reset(snapshot.state)\n      }\n    },\n\n    after(asyncId) {\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        snapshot.state = sheet.reset(initial)\n      }\n    },\n\n    destroy(asyncId) {\n      store.delete(asyncId)\n    },\n  }).enable()\n\n  return {\n    get target() {\n      return sheet.target\n    },\n    insert: sheet.insert,\n    init: sheet.init,\n    reset: () => {\n      const asyncId = executionAsyncId()\n\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        snapshot.state = undefined\n      } else {\n        store.set(asyncId, { state: undefined })\n      }\n\n      sheet.reset()\n    },\n    enable: () => asyncHook.enable(),\n    disable: () => asyncHook.disable(),\n  }\n}\n", "/* eslint-env node */\n// ^^^^ This comment is need to prevent browser bundles of this file\n\nimport { executionAsyncId, createHook } from 'async_hooks'\n\nimport type { Sheet, SheetInit } from '../types'\nimport { virtualSheet } from '../sheets'\n\nexport type { Storage, StyleTagProperties, StyleTagSheet, VirtualSheet } from '../sheets'\nexport { virtualSheet, getStyleTag, getStyleTagProperties } from '../sheets'\n\nexport interface AsyncVirtualSheet extends Sheet {\n  readonly target: readonly string[]\n  init: SheetInit\n  reset: () => void\n  enable: () => void\n  disable: () => void\n}\n\ninterface Snapshot {\n  state: unknown[] | undefined\n}\n\nexport const asyncVirtualSheet = (): AsyncVirtualSheet => {\n  const sheet = virtualSheet()\n  const initial = sheet.reset()\n\n  const store = new Map<number, Snapshot>()\n\n  const asyncHook = createHook({\n    init(asyncId, type, triggerAsyncId) {\n      const snapshot = store.get(triggerAsyncId)\n\n      if (snapshot) {\n        store.set(asyncId, snapshot)\n      }\n    },\n\n    before(asyncId) {\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        sheet.reset(snapshot.state)\n      }\n    },\n\n    after(asyncId) {\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        snapshot.state = sheet.reset(initial)\n      }\n    },\n\n    destroy(asyncId) {\n      store.delete(asyncId)\n    },\n  }).enable()\n\n  return {\n    get target() {\n      return sheet.target\n    },\n    insert: sheet.insert,\n    init: sheet.init,\n    reset: () => {\n      const asyncId = executionAsyncId()\n\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        snapshot.state = undefined\n      } else {\n        store.set(asyncId, { state: undefined })\n      }\n\n      sheet.reset()\n    },\n    enable: () => asyncHook.enable(),\n    disable: () => asyncHook.disable(),\n  }\n}\n", "export const STYLE_ELEMENT_ID = '__twind' as const\n\ndeclare global {\n  interface Window {\n    [STYLE_ELEMENT_ID]?: HTMLStyleElement\n  }\n}\n\nexport const getStyleElement = (nonce?: string): HTMLStyleElement => {\n  // Hydrate existing style element if available\n  // self[id] - every element with an id is available through the global object\n  // eslint-disable-next-line no-restricted-globals\n  let element = self[STYLE_ELEMENT_ID]\n\n  if (!element) {\n    // Create a new one otherwise\n    element = document.head.appendChild(document.createElement('style'))\n\n    element.id = STYLE_ELEMENT_ID\n    nonce && (element.nonce = nonce)\n\n    // Avoid Edge bug where empty style elements doesn't create sheets\n    element.appendChild(document.createTextNode(''))\n  }\n\n  return element\n}\n", "import type { SheetConfig, Sheet, SheetInit, SheetInitCallback } from '../types'\nimport { getStyleElement, STYLE_ELEMENT_ID } from '../internal/dom'\n\n/**\n * Creates an sheet which inserts style rules through the Document Object Model.\n */\nexport const domSheet = ({\n  nonce,\n  target = getStyleElement(nonce),\n}: SheetConfig<HTMLStyleElement> = {}): Sheet<HTMLStyleElement> => ({\n  target,\n  insert: (rule, index) => {\n    target.insertBefore(document.createTextNode(rule), target.childNodes[index])\n  },\n})\n\n/**\n * Allows to reset and snaphot the current state of an sheet and\n * in extension the internal mutable state (caches, ...) of `tw`.\n */\nexport interface Storage {\n  /**\n   * Register a function that should be called to create a new state.\n   */\n  init: SheetInit\n\n  /**\n   * Creates a snapshot of the current state, invokes all init callbacks to create a fresh state\n   * and returns the snaphot.\n   */\n  reset: (snapshot?: unknown[] | undefined) => unknown[]\n}\n\nconst createStorage = (): Storage => {\n  const callbacks: SheetInitCallback[] = []\n  let state: unknown[] = []\n\n  const invoke = <T>(callback: SheetInitCallback<T>, index: number): T =>\n    (state[index] = callback(state[index] as T))\n\n  return {\n    init: (callback) => invoke(callback, callbacks.push(callback as SheetInitCallback) - 1),\n    reset: (snapshot = []) => {\n      // eslint-disable-next-line @typescript-eslint/no-extra-semi\n      ;[snapshot, state] = [state, snapshot]\n      callbacks.forEach(invoke)\n      return snapshot\n    },\n  }\n}\n\nexport interface VirtualSheet extends Sheet<string[]>, Storage {\n  init: SheetInit\n}\n\n/**\n * Creates an sheet which collects style rules into an array.\n */\nexport const virtualSheet = (): VirtualSheet => {\n  const storage = createStorage()\n\n  let target: string[]\n  storage.init<string[]>((value = []) => (target = value))\n\n  return {\n    ...storage,\n    get target() {\n      return [...target]\n    },\n    insert: (rule, index) => target.splice(index, 0, rule),\n  }\n}\n\nexport interface StyleTagProperties {\n  id: string\n  textContent: string\n}\n\nexport interface HasTarget {\n  readonly target: readonly string[]\n}\n\nexport type StyleTagSheet = HasTarget | readonly string[]\n\n/**\n * Transforms css rules into `<style>` tag properties.\n */\nexport const getStyleTagProperties = (sheet: StyleTagSheet): StyleTagProperties => ({\n  id: STYLE_ELEMENT_ID,\n  textContent: (Array.isArray(sheet) ? sheet : (sheet as HasTarget).target).join(''),\n})\n\n/**\n * Transforms css rules into a `<style>` tag string.\n */\nexport const getStyleTag = (sheet: StyleTagSheet, attributes?: Record<string, string>): string => {\n  const { id, textContent } = getStyleTagProperties(sheet)\n\n  attributes = { ...attributes, id }\n\n  return `<style${Object.keys(attributes).reduce(\n    (attrs, key) =>\n      `${attrs} ${key}=${JSON.stringify((attributes as Record<string, string>)[key])}`,\n    '',\n  )}>${textContent}</style>`\n}\n", "/* eslint-env node */\n// ^^^^ This comment is need to prevent browser bundles of this file\n\nimport { executionAsyncId, createHook } from 'async_hooks'\n\nimport type { Sheet, SheetInit } from '../types'\nimport { virtualSheet } from '../sheets'\n\nexport type { Storage, StyleTagProperties, StyleTagSheet, VirtualSheet } from '../sheets'\nexport { virtualSheet, getStyleTag, getStyleTagProperties } from '../sheets'\n\nexport interface AsyncVirtualSheet extends Sheet {\n  readonly target: readonly string[]\n  init: SheetInit\n  reset: () => void\n  enable: () => void\n  disable: () => void\n}\n\ninterface Snapshot {\n  state: unknown[] | undefined\n}\n\nexport const asyncVirtualSheet = (): AsyncVirtualSheet => {\n  const sheet = virtualSheet()\n  const initial = sheet.reset()\n\n  const store = new Map<number, Snapshot>()\n\n  const asyncHook = createHook({\n    init(asyncId, type, triggerAsyncId) {\n      const snapshot = store.get(triggerAsyncId)\n\n      if (snapshot) {\n        store.set(asyncId, snapshot)\n      }\n    },\n\n    before(asyncId) {\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        sheet.reset(snapshot.state)\n      }\n    },\n\n    after(asyncId) {\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        snapshot.state = sheet.reset(initial)\n      }\n    },\n\n    destroy(asyncId) {\n      store.delete(asyncId)\n    },\n  }).enable()\n\n  return {\n    get target() {\n      return sheet.target\n    },\n    insert: sheet.insert,\n    init: sheet.init,\n    reset: () => {\n      const asyncId = executionAsyncId()\n\n      const snapshot = store.get(asyncId)\n\n      if (snapshot) {\n        snapshot.state = undefined\n      } else {\n        store.set(asyncId, { state: undefined })\n      }\n\n      sheet.reset()\n    },\n    enable: () => asyncHook.enable(),\n    disable: () => asyncHook.disable(),\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;ACGA,IAAA,cAA6C;;;ACHtC,IAAM,mBAAmB;;;ACiChC,IAAM,gBAAgB;AACpB,oBAAuC;AACvC,cAAuB;AAEvB,iBAAe,qBACZ,MAAM,SAAS,SAAS,MAAM;AAEjC,SAAO;AAAA,IACL,MAAM,cAAc,OAAO,UAAU,UAAU,KAAK,YAAiC;AAAA,IACrF,OAAO,YAAY;AAEjB;AAAC,OAAC,UAAU,SAAS,CAAC,OAAO;AAC7B,gBAAU,QAAQ;AAClB,aAAO;AAAA;AAAA;AAAA;AAYN,mBAAqB;AAC1B,kBAAgB;AAEhB;AACA,UAAQ,KAAe,SAAS,OAAQ,SAAS;AAEjD,SAAO;AAAA,OACF;AAAA,QACC;AACF,aAAO,CAAC,GAAG;AAAA;AAAA,IAEb,QAAQ,iBAAiB,OAAO,OAAO,OAAO,GAAG;AAAA;AAAA;AAkB9C,4BAA8B,WAA+C;AAAA,EAClF,IAAI;AAAA,EACJ,aAAc,OAAM,QAAQ,SAAS,QAAS,MAAoB,QAAQ,KAAK;AAAA;AAM1E,kBAAoB;AACzB,SAAQ,IAAI,eAAgB,sBAAsB;AAElD,eAAa,IAAK,YAAY;AAE9B,SAAO,SAAS,OAAO,KAAK,YAAY,OACtC,gBACE,GAAG,SAAS,OAAO,KAAK,UAAW,WAAsC,SAC3E,OACG;AAAA;;;ACjFA,IAAM,oBAAoB;AAC/B,gBAAc;AACd,kBAAgB,MAAM;AAEtB,gBAAc,IAAI;AAElB,oBAAkB,uBAAW;AAAA,IAC3B;AACE,uBAAiB,MAAM,IAAI;AAE3B,UAAI;AACF,cAAM,IAAI,SAAS;AAAA;AAAA;AAAA,IAIvB;AACE,uBAAiB,MAAM,IAAI;AAE3B,UAAI;AACF,cAAM,MAAM,SAAS;AAAA;AAAA;AAAA,IAIzB;AACE,uBAAiB,MAAM,IAAI;AAE3B,UAAI;AACF,iBAAS,QAAQ,MAAM,MAAM;AAAA;AAAA;AAAA,IAIjC;AACE,YAAM,OAAO;AAAA;AAAA,KAEd;AAEH,SAAO;AAAA,QACD;AACF,aAAO,MAAM;AAAA;AAAA,IAEf,QAAQ,MAAM;AAAA,IACd,MAAM,MAAM;AAAA,IACZ,OAAO;AACL,sBAAgB;AAEhB,uBAAiB,MAAM,IAAI;AAE3B,UAAI;AACF,iBAAS,QAAQ;AAAA;AAEjB,cAAM,IAAI,SAAS,CAAE,OAAO;AAAA;AAG9B,YAAM;AAAA;AAAA,IAER,QAAQ,MAAM,UAAU;AAAA,IACxB,SAAS,MAAM,UAAU;AAAA;AAAA;",
  "names": []
}
